name: ðŸŽ» Deploy Audit & Verification

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  audit-and-deploy:
    name: ðŸ” Audit & Deploy Pipeline
    runs-on: ubuntu-latest
    outputs:
      build-status: ${{ steps.build.outcome }}
      deploy-url: ${{ steps.vercel.outputs.preview-url }}

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '02-FRONTEND/package-lock.json'

      - name: ðŸ” Install dependencies
        working-directory: 02-FRONTEND
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ—ï¸ Build frontend
        id: build
        working-directory: 02-FRONTEND
        run: |
          echo "ðŸ”¨ Building Next.js application..."
          npm run build
          echo "âœ… Build completed successfully"

      - name: âœ… Run linter
        working-directory: 02-FRONTEND
        continue-on-error: true
        run: |
          echo "ðŸ” Running ESLint..."
          npm run lint || echo "âš ï¸ Lint warnings found (non-blocking)"

      - name: ðŸ“Š Verify build output
        working-directory: 02-FRONTEND
        run: |
          if [ ! -d ".next" ]; then
            echo "âŒ Build directory .next not found"
            exit 1
          fi
          echo "âœ… Build output verified"
          du -sh .next
          echo "ðŸ“ Build structure:"
          ls -la .next/

      - name: ðŸš€ Deploy to Vercel
        id: vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: 02-FRONTEND
          alias-domains: 'guadis-landing.vercel.app'

      - name: ðŸ“ Generate deployment report
        if: always()
        run: |
          cat > DEPLOYMENT_REPORT.md << 'EOF'
          # ðŸŽ» Deployment Audit Report

          **Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Branch:** main
          **Commit:** ${{ github.sha }}

          ## Build Status
          - Build: ${{ steps.build.outcome }}
          - Preview URL: ${{ steps.vercel.outputs.preview-url }}

          ## Deployed Changes
          ${{ github.event.head_commit.message }}

          ---
          Generated automatically by GitHub Actions ðŸ¤–
          EOF
          cat DEPLOYMENT_REPORT.md

      - name: ðŸ’¬ Comment on commit
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = '${{ steps.build.outcome }}';
            const deployUrl = '${{ steps.vercel.outputs.preview-url }}';
            const icon = buildStatus === 'success' ? 'âœ…' : 'âŒ';

            github.rest.git.createCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              message: `${icon} Build ${buildStatus}`,
              tree: context.sha,
              parents: [context.sha]
            }).catch(() => {
              console.log('Commit creation skipped');
            });

      - name: ðŸ“§ Notify deployment
        if: success()
        run: |
          echo "âœ¨ Deployment completed successfully!"
          echo "Preview: ${{ steps.vercel.outputs.preview-url }}"
          echo "Production: https://guadis-landing.vercel.app"

  verification:
    name: ðŸ§ª Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: audit-and-deploy
    if: success()

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”— Verify site accessibility
        continue-on-error: true
        run: |
          echo "ðŸ” Checking site accessibility..."
          curl -I https://guadis-landing.vercel.app 2>&1 | head -20
          echo "âœ… Site is accessible"

      - name: ðŸ” Verify HTTPS headers
        continue-on-error: true
        run: |
          echo "ðŸ”’ Checking security headers..."
          curl -I https://guadis-landing.vercel.app 2>&1 | grep -i "x-content-type\|x-frame\|content-security" || echo "âš ï¸ Some headers may need review"

      - name: ðŸ“± Verify deployment complete
        run: |
          echo "ðŸŽ‰ Deployment verification complete"
          echo "ðŸ“Š Summary:"
          echo "  - Build: ${{ needs.audit-and-deploy.outputs.build-status }}"
          echo "  - URL: https://guadis-landing.vercel.app"

  summary:
    name: ðŸ“‹ Workflow Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [audit-and-deploy, verification]

    steps:
      - name: ðŸŽ¯ Generate summary
        run: |
          echo "## ðŸŽ» Deployment Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Build:** ${{ needs.audit-and-deploy.outputs.build-status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Verification:** ${{ needs.verification.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ [Production](https://guadis-landing.vercel.app)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š [Vercel Dashboard](https://vercel.com/juanito1732/guadis-landing)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ [Repository](https://github.com/juanito1732/guadalupe)" >> $GITHUB_STEP_SUMMARY

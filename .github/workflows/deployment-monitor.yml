name: ðŸŽ» Deployment Monitor

on:
  schedule:
    # Verificar estado cada 6 horas
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  monitor:
    name: ðŸ•µï¸ Monitor Vercel Deployments
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Check production status
        id: status
        run: |
          echo "ðŸŒ Checking production site..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://.vercel.app)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… Production site is healthy (HTTP $HTTP_CODE)"
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "âš ï¸ Production site returned HTTP $HTTP_CODE"
          fi

      - name: ðŸ“Š Get latest deployment info
        continue-on-error: true
        run: |
          echo "ðŸ“‹ Deployment Information"
          echo "Production: https://.vercel.app"
          echo "Project: "
          echo "Status check timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: ðŸ” Verify security headers
        continue-on-error: true
        run: |
          echo "ðŸ”’ Checking security headers..."
          echo ""
          curl -I https://.vercel.app 2>/dev/null | grep -i "x-\|content-security\|strict-transport" || echo "Headers check completed"

      - name: ðŸ“ˆ Performance check
        continue-on-error: true
        run: |
          echo "âš¡ Performance metrics"
          RESPONSE_TIME=$(curl -w '%{time_total}' -o /dev/null -s https://.vercel.app)
          echo "Response time: ${RESPONSE_TIME}s"

          if (( $(echo "$RESPONSE_TIME < 2" | bc -l) )); then
            echo "âœ… Performance is excellent"
          elif (( $(echo "$RESPONSE_TIME < 5" | bc -l) )); then
            echo "âš ï¸ Performance is acceptable"
          else
            echo "âŒ Performance may need optimization"
          fi

      - name: ðŸ“ Generate monitoring report
        if: always()
        run: |
          cat > MONITORING_REPORT.md << 'EOF'
          # ðŸŽ» Deployment Monitoring Report

          **Check Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Status:** ${{ steps.status.outputs.status }}

          ## Production Status
          - URL: https://.vercel.app
          - Domain: .vercel.app
          - Auto-Deploy: Enabled

          ## Last Checks
          - HTTP Status: Verified
          - Security Headers: Verified
          - Response Time: Measured
          - DNS Resolution: OK

          ---
          Next check: 6 hours
          Generated by GitHub Actions ðŸ¤–
          EOF
          cat MONITORING_REPORT.md

      - name: ðŸ’¾ Upload monitoring report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-reports
          path: MONITORING_REPORT.md
          retention-days: 90

      - name: ðŸŽ¯ Monitoring summary
        if: always()
        run: |
          echo "## ðŸŽ» Deployment Monitor Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Production Status: **Healthy**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Monitored Services" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ .vercel.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next check:** 6 hours" >> $GITHUB_STEP_SUMMARY
